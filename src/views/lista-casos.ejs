<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de Casos - OVD</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
          <i class="bi bi-shield-check"></i> OVD - Exaltaci贸n de la Cruz
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/dashboard">
                <i class="bi bi-house-door"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agregar-persona">
                <i class="bi bi-person-plus"></i> Agregar Persona
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agregar-caso">
                <i class="bi bi-file-earmark-plus"></i> Agregar Caso
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/lista-casos">
                <i class="bi bi-list-ul"></i> Lista de Casos
              </a>
            </li>
          </ul>

          <div class="dropdown me-3">
            <button
              class="btn btn-outline-light dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="bi bi-person-circle"></i>
              <span id="currentUser">Usuario</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/register">
                  <i class="bi bi-gear"></i> Configuraci贸n
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button class="dropdown-item text-danger" onclick="logout()">
                  <i class="bi bi-box-arrow-right"></i> Cerrar sesi贸n
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container py-4">
      <div class="row mb-3">
        <div class="col-md-6">
          <h4>Lista de Casos</h4>
        </div>
        <div class="col-md-6 text-end">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Buscar por nombre, DNI o tipo de caso"
          />
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>DNI</th>
              <th>Tel茅fono</th>
              <th>Tipo de Caso</th>
              <th>Zona</th>
              <th>Fecha Creaci贸n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCasos">
            <% if (casos.length === 0) { %>
            <tr>
              <td colspan="9" class="text-center">No hay casos registrados</td>
            </tr>
            <% } else { %> <% casos.forEach(caso => { %>
            <tr>
              <td><%= caso.id %></td>
              <td><%= caso.nombre %></td>
              <td><%= caso.apellido %></td>
              <td><%= caso.dni %></td>
              <td><%= caso.telefono %></td>
              <td><%= caso.tipo_caso %></td>
              <td><%= caso.zona %></td>
              < <
              <td <% if (caso.fecha_creada) { %>
                data-fecha="<%= caso.fecha_creada.toISOString() %>" <% } %> >
                <%= caso.fecha_creada ? new
                Date(caso.fecha_creada).toLocaleString('es-AR', { timeZone:
                'America/Argentina/Buenos_Aires' }) : '-' %>
              </td>

              <td>
                <button
                  class="btn btn-info btn-sm"
                  onclick="verDetalles('<%= caso.id %>')"
                >
                  
                </button>
                <button
                  class="btn btn-warning btn-sm"
                  onclick="editarCaso('<%= caso.id %>')"
                >
                  锔
                </button>
              </td>
            </tr>
            <% }) %> <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- MODAL DETALLES -->
    <div class="modal fade" id="modalDetalles" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalles del Caso</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="detallesCaso">
            <!-- Detalles cargados din谩micamente -->
          </div>
        </div>
      </div>
    </div>
    <div style="max-width: 100%" class="p-4 d-flex flex-column align-items-end">
      <div class="my-5" style="width: 500px">
        <div class="mb-2 w-100">
          <label for="fechaDesde" class="form-label">Desde:</label>
          <input type="date" id="fechaDesde" class="form-control" />
        </div>
        <div class="mb-2 w-100">
          <label for="fechaHasta" class="form-label">Hasta:</label>
          <input type="date" id="fechaHasta" class="form-control" />
        </div>
        <div class="d-flex flex-column gap-2 w-100">
          <button id="btnExportFiltro" class="btn btn-primary">
            Filtrar Tabla
          </button>
          <button id="btnExcel" class="btn btn-success">
            Exportar a Excel
          </button>
          <button id="btnPDF" class="btn btn-danger">Exportar a PDF</button>
        </div>
      </div>
    </div>
    <!-- MODAL EDITAR -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Caso</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formEditarCaso">
              <input type="hidden" id="editCasoId" />

              <div class="mb-3">
                <label for="editNombre" class="form-label">Nombre</label>
                <input
                  type="text"
                  id="editNombre"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editApellido" class="form-label">Apellido</label>
                <input
                  type="text"
                  id="editApellido"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editDNI" class="form-label">DNI</label>
                <input type="text" id="editDNI" class="form-control" required />
              </div>

              <div class="mb-3">
                <label for="editTelefono" class="form-label">Tel茅fono</label>
                <input type="text" id="editTelefono" class="form-control" />
              </div>

              <div class="mb-3">
                <label for="editTipoCaso" class="form-label"
                  >Tipo de Caso</label
                >
                <select class="form-select" id="editTipoCaso" required></select>
              </div>

              <div class="mb-3">
                <label for="editZona" class="form-label">Zona</label>
                <select class="form-select" id="editZona" required></select>
              </div>

              <div class="mb-3">
                <label for="editObservaciones" class="form-label"
                  >Observaciones</label
                >
                <textarea
                  class="form-control"
                  id="editObservaciones"
                  rows="3"
                ></textarea>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save"></i> Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
      async function logout() {
        try {
          const response = await fetch("/logout", {
            method: "POST",
            credentials: "include",
          });
          if (response.ok) {
            window.location.href = "/login?alert=logout";
          } else {
            alert("No se pudo cerrar la sesi贸n");
          }
        } catch (err) {
          console.error(err);
          alert("Error al cerrar la sesi贸n");
        }
      }

      async function verDetalles(casoId) {
        try {
          const res = await fetch(`/api/casos/${casoId}`);
          if (!res.ok) throw new Error("No se pudo obtener el caso");

          const { caso } = await res.json(); //  accedemos a "caso" dentro del objeto

          // Construir HTML con la info del caso
          const html = `
      <p><strong>ID:</strong> ${caso.id}</p>
      <p><strong>Nombre:</strong> ${caso.nombre} ${caso.apellido}</p>
      <p><strong>DNI:</strong> ${caso.dni}</p>
      <p><strong>Tel茅fono:</strong> ${caso.telefono}</p>
      <p><strong>Tipo de Caso:</strong> ${caso.tipo_caso}</p>
      <p><strong>Zona:</strong> ${caso.zona}</p>
      <p><strong>Observaciones:</strong> ${caso.observacion || "-"}</p>
      <p><strong>Fecha Creaci贸n:</strong> ${new Date(
        caso.fecha_creada
      ).toLocaleString("es-AR")}</p>
      <p><strong>ltima Actualizaci贸n:</strong> ${new Date(
        caso.fecha_actualizado
      ).toLocaleString("es-AR")}</p>
    `;

          document.getElementById("detallesCaso").innerHTML = html;

          // Mostrar el modal
          new bootstrap.Modal(document.getElementById("modalDetalles")).show();
        } catch (err) {
          console.error(err);
          alert("Error al cargar detalles del caso");
        }
      }

      async function editarCaso(casoId) {
        try {
          const res = await fetch(`/api/casos/${casoId}`);
          if (!res.ok) throw new Error("No se pudo obtener el caso");

          const { caso, delitos, zonas } = await res.json();

          // Rellenar campos de persona
          document.getElementById("editCasoId").value = caso.id;
          document.getElementById("editNombre").value = caso.nombre;
          document.getElementById("editApellido").value = caso.apellido;
          document.getElementById("editDNI").value = caso.dni;
          document.getElementById("editTelefono").value = caso.telefono;

          // Llenar select de tipo de caso
          const tipoSelect = document.getElementById("editTipoCaso");
          tipoSelect.innerHTML = "";
          delitos.forEach((d) => {
            const selected = d.id_delito === caso.id_delito ? "selected" : "";
            tipoSelect.innerHTML += `<option value="${d.id_delito}" ${selected}>${d.tipo_delito}</option>`;
          });

          // Llenar select de zona
          const zonaSelect = document.getElementById("editZona");
          zonaSelect.innerHTML = "";
          zonas.forEach((z) => {
            const selected = z.id_zona === caso.id_zona ? "selected" : "";
            zonaSelect.innerHTML += `<option value="${z.id_zona}" ${selected}>${z.nombre_zona}</option>`;
          });

          // Observaciones
          document.getElementById("editObservaciones").value =
            caso.observacion || "";

          // Mostrar modal
          new bootstrap.Modal(document.getElementById("modalEditar")).show();
        } catch (err) {
          console.error(err);
          alert("Error al cargar el caso para editar");
        }
      }

      document
        .getElementById("formEditarCaso")
        .addEventListener("submit", async (e) => {
          e.preventDefault(); // Evita que recargue la p谩gina

          const id = document.getElementById("editCasoId").value;
          const nombre = document.getElementById("editNombre").value;
          const apellido = document.getElementById("editApellido").value;
          const dni = document.getElementById("editDNI").value;
          const telefono = document.getElementById("editTelefono").value;
          const tipo_caso = document.getElementById("editTipoCaso").value;
          const zona = document.getElementById("editZona").value;
          const observaciones =
            document.getElementById("editObservaciones").value;

          try {
            const res = await fetch(`/api/casos/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nombre,
                apellido,
                dni,
                telefono,
                tipo_caso,
                zona,
                observaciones,
              }),
            });

            const data = await res.json();

            if (res.ok) {
              alert("Caso actualizado correctamente");
              location.reload(); // recarga la tabla para ver cambios
            } else {
              alert("Error al actualizar caso: " + data.message);
            }
          } catch (err) {
            console.error(err);
            alert("Error al actualizar caso");
          }
        });

      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", () => {
        const term = searchInput.value.toLowerCase();
        const rows = document.querySelectorAll("#tablaCasos tr");

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const textoFila = Array.from(cells)
            .map((cell) => cell.textContent.toLowerCase())
            .join(" ");

          if (textoFila.includes(term)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      });

      // Por defecto, fechaHasta = hoy
      // Filtrar tabla por fechas y b煤squeda
      function filtrarTabla() {
        const desdeVal = document.getElementById("fechaDesde").value;
        const hastaVal = document.getElementById("fechaHasta").value;
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        // Convertir fechas
        const desde = desdeVal ? new Date(desdeVal + "T00:00:00") : null;
        const hasta = hastaVal ? new Date(hastaVal + "T23:59:59") : new Date();

        if (desde) desde.setHours(0, 0, 0, 0);
        if (hasta) hasta.setHours(23, 59, 59, 999);

        const rows = document.querySelectorAll("#tablaCasos tr");

        rows.forEach((row) => {
          const fechaTd = row.querySelector("td:nth-child(8)");
          if (!fechaTd) return;

          const fechaText = fechaTd.textContent.trim();
          if (!fechaText || fechaText === "31/12/1969") {
            row.style.display = "none";
            return;
          }

          const fechaIso = fechaTd.dataset.fecha;
          const fechaUtc = new Date(fechaIso);
          const fecha = new Date(
            fechaUtc.toLocaleString("en-US", {
              timeZone: "America/Argentina/Buenos_Aires",
            })
          );
          fecha.setHours(0, 0, 0, 0); // para comparar solo la fecha

          const cumpleFecha = (!desde || fecha >= desde) && fecha <= hasta;

          // Filtrar por b煤squeda
          const textoFila = Array.from(row.querySelectorAll("td"))
            .map((cell) => cell.textContent.toLowerCase())
            .join(" ");
          const cumpleBusqueda = textoFila.includes(searchTerm);

          row.style.display = cumpleFecha && cumpleBusqueda ? "" : "none";
        });
      }

      // Filtrar al presionar el bot贸n
      document
        .getElementById("btnExportFiltro")
        .addEventListener("click", filtrarTabla);

      // Filtrar autom谩ticamente al cambiar fechas
      document
        .getElementById("fechaDesde")
        .addEventListener("change", filtrarTabla);
      document
        .getElementById("fechaHasta")
        .addEventListener("change", filtrarTabla);

      // Filtrar tambi茅n al escribir en el buscador
      document
        .getElementById("searchInput")
        .addEventListener("input", filtrarTabla);

      // Exportar solo filas visibles
      function exportTablaExcel() {
        const table = document.querySelector("table.table");
        const tempTable = document.createElement("table");
        tempTable.appendChild(table.querySelector("thead").cloneNode(true));

        const tbody = document.createElement("tbody");
        Array.from(table.querySelectorAll("tbody tr"))
          .filter((row) => row.style.display !== "none")
          .forEach((row) => {
            const clone = row.cloneNode(true);
            clone
              .querySelectorAll("td:last-child")
              .forEach((td) => td.remove());
            tbody.appendChild(clone);
          });
        tempTable.appendChild(tbody);

        const wb = XLSX.utils.table_to_book(tempTable, { sheet: "Casos" });
        XLSX.writeFile(wb, "casos.xlsx");
      }

      function exportTablaPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const table = document.querySelector("table.table");
        const tempTable = document.createElement("table");
        tempTable.appendChild(table.querySelector("thead").cloneNode(true));

        const tbody = document.createElement("tbody");
        Array.from(table.querySelectorAll("tbody tr"))
          .filter((row) => row.style.display !== "none")
          .forEach((row) => {
            const clone = row.cloneNode(true);
            clone
              .querySelectorAll("td:last-child")
              .forEach((td) => td.remove());
            tbody.appendChild(clone);
          });
        tempTable.appendChild(tbody);

        doc.autoTable({ html: tempTable });
        doc.save("casos.pdf");
      }

      document
        .getElementById("btnExcel")
        .addEventListener("click", exportTablaExcel);
      document
        .getElementById("btnPDF")
        .addEventListener("click", exportTablaPDF);
    </script>
  </body>
</html>
