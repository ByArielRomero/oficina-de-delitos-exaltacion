<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agregar Caso - OVD</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
<div class="container-fluid">
<a class="navbar-brand" href="/dashboard">  <!-- Ruta pura -->
<i class="bi bi-shield-check"></i> OVD - Exaltación de la Cruz
</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto">
<li class="nav-item">
<a class="nav-link" href="/dashboard"><i class="bi bi-house-door"></i> Dashboard</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/agregar-persona"><i class="bi bi-person-plus"></i> Agregar Persona</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="/agregar-caso"><i class="bi bi-file-earmark-plus"></i> Agregar Caso</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/lista-casos"><i class="bi bi-list-ul"></i> Lista de Casos</a>
</li>
</ul>
<div class="dropdown me-3">
<button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
<i class="bi bi-person-circle"></i>
<span id="currentUser">Usuario</span>
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li>
<a class="dropdown-item" href="/register"><i class="bi bi-gear"></i> Configuración</a>
</li>
<li><hr class="dropdown-divider" /></li>
<li>
<button class="dropdown-item text-danger" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Cerrar sesión
</button>
</li>
</ul>
</div>
</div>
</div>
</nav>
<div class="container py-4">
<div class="row justify-content-center">
<div class="col-lg-8">
<div class="card">
<div class="card-header">
<h4 class="mb-0"><i class="bi bi-file-earmark-plus"></i> Agregar Nuevo Caso</h4>
</div>
<div class="card-body">
<form id="formCaso">
<div class="mb-3">
<label for="personaId" class="form-label">Seleccionar Persona <span class="text-danger">*</span></label>
<select class="form-select" id="personaId" required>
<option value="">Seleccione una persona</option>
</select>
<small class="text-muted">Si la persona no está en la lista, <a href="/agregar-persona">agréguela aquí</a></small>  <!-- Ruta pura -->
</div>
<!-- AGREGADO: Select para Zona (requerido en DB) -->
<div class="mb-3">
<label for="zonaId" class="form-label">Zona <span class="text-danger">*</span></label>
<select class="form-select" id="zonaId" required>
<option value="">Seleccione una zona</option>
</select>
</div>
<div class="mb-3">
<label for="tipoCaso" class="form-label">Tipo de Caso/Delito <span class="text-danger">*</span></label>
<div class="input-group">
<select class="form-select" id="tipoCaso" required>
<option value="">Seleccione un tipo</option>
</select>
<button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalAgregarTipo">
<i class="bi bi-plus-circle"></i> Agregar Tipo
</button>
</div>
</div>
<div class="mb-3">
<label for="observaciones" class="form-label">Observaciones</label>
<textarea class="form-control" id="observaciones" rows="4"></textarea>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label for="fechaCreacion" class="form-label">Fecha de Creación</label>
<input type="date" class="form-control" id="fechaCreacion">
</div>
<div class="col-md-6 mb-3">
<label for="fechaActualizacion" class="form-label">Fecha de Actualización</label>
<input type="date" class="form-control" id="fechaActualizacion">
</div>
</div>
<div class="mb-3">
<label for="usuarioAsignado" class="form-label">Usuario Asignado al Caso</label>
<select class="form-select" id="usuarioAsignado">
<option value="">Sin asignar</option>
</select>
</div>
<div class="d-grid gap-2">
<button type="submit" class="btn btn-primary">
<i class="bi bi-save"></i> Guardar Caso
</button>
<a href="/dashboard" class="btn btn-secondary">  <!-- Ruta pura -->
<i class="bi bi-x-circle"></i> Cancelar
</a>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
<!-- Modal Agregar Tipo de Caso -->
<div class="modal fade" id="modalAgregarTipo" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Agregar Nuevo Tipo de Caso</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="formTipoCaso">
<div class="mb-3">
<label for="nombreTipoCaso" class="form-label">Nombre del Tipo de Caso</label>
<input type="text" class="form-control" id="nombreTipoCaso" required>
</div>
<button type="submit" class="btn btn-primary w-100">
<i class="bi bi-plus-circle"></i> Agregar
</button>
</form>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  <!-- Para Swal en logout -->
<!-- Tus scripts (cambia a /js/ si static) -->
<script src="/js/auth.js"></script>
<script src="/js/data.js"></script>
<script src="/js/agregar-caso.js"></script>
<script>
async function logout() {
  try {
    const response = await fetch("/logout", {
      method: "POST",
      credentials: "include"
    });
    if (response.ok) {
      window.location.href = "/login?alert=logout";
    } else {
      Swal.fire("Error", "No se pudo cerrar la sesión", "error");
    }
  } catch (err) {
    console.error(err);
    Swal.fire("Error", "Hubo un problema al cerrar la sesión", "error");
  }
}
</script>
</body>
</html>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const personaSelect = document.getElementById('personaId');
  const zonaSelect = document.getElementById('zonaId');
  const tipoCasoSelect = document.getElementById('tipoCaso');
  const usuarioAsignadoSelect = document.getElementById('usuarioAsignado');
  const formCaso = document.getElementById('formCaso');
  const formTipoCaso = document.getElementById('formTipoCaso');
  const fechaCreacionInput = document.getElementById('fechaCreacion');
  const fechaActualizacionInput = document.getElementById('fechaActualizacion');

  await loadInitialData();  // Pobla selects con nombres de DB

  // Submit modal: Agregar tipo
  formTipoCaso.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tipoDelito = document.getElementById('nombreTipoCaso').value.trim();
    if (!tipoDelito) return;

    try {
      const response = await fetch('/api/casos/delito', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ tipo_delito: tipoDelito })
      });
      const result = await response.json();
      if (result.success) {
        const option = new Option(result.data.tipo_delito, result.data.id);
        tipoCasoSelect.appendChild(option);
        tipoCasoSelect.value = result.data.id;
        bootstrap.Modal.getInstance(document.getElementById('modalAgregarTipo')).hide();
        document.getElementById('nombreTipoCaso').value = '';
        alert('Tipo agregado');
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error al agregar tipo');
    }
  });

  // Submit form: Crear caso
  formCaso.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
      observacion: document.getElementById('observaciones').value,
      id_persona: personaSelect.value,
      id_zona: zonaSelect.value,
      id_usuario: usuarioAsignadoSelect.value || null,
      id_delito: tipoCasoSelect.value,
      fecha_creacion: fechaCreacionInput.value,
      fecha_actualizacion: fechaActualizacionInput.value
    };

    if (!formData.id_persona || !formData.id_delito || !formData.id_zona) {
      alert('Persona, zona y tipo son requeridos');
      return;
    }

    try {
      const response = await fetch('/api/casos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(formData)
      });
      const result = await response.json();
      if (result.success) {
        alert('Caso creado');
        formCaso.reset();
        window.location.href = '/dashboard';
      } else {
        alert('Error: ' + result.message);
      }
    } catch (error) {
      alert('Error al crear caso');
    }
  });

  async function loadInitialData() {
    try {
      const response = await fetch('/api/casos/data', { credentials: 'include' });
      const result = await response.json();
      console.log(result)
      if (result.success) {
        // Poblar personas (nombre completo de DB)
        personaSelect.innerHTML = '<option value="">Seleccione una persona</option>';
        result.data.personas.forEach(p => {
          const option = new Option(p.nombre_completo, p.id_persona);  // Nombre completo como text, id como value
          personaSelect.appendChild(option);
        });

        // Poblar zonas
        zonaSelect.innerHTML = '<option value="">Seleccione una zona</option>';
        result.data.zonas.forEach(z => {
          const option = new Option(z.nombre_zona, z.id_zona);
          zonaSelect.appendChild(option);
        });

        // Poblar delitos
        tipoCasoSelect.innerHTML = '<option value="">Seleccione un tipo</option>';
        result.data.delitos.forEach(d => {
          const option = new Option(d.tipo_delito, d.id_delito);
          tipoCasoSelect.appendChild(option);
        });

        // Poblar usuarios
        usuarioAsignadoSelect.innerHTML = '<option value="">Sin asignar</option>';
        result.data.usuarios.forEach(u => {
          const option = new Option(u.nombre_usuario, u.id_usuario);
          usuarioAsignadoSelect.appendChild(option);
        });

        // Fechas por defecto
        const today = new Date().toISOString().split('T')[0];
        fechaCreacionInput.value = today;
        fechaActualizacionInput.value = today;
      } else {
        alert('Error al cargar datos: ' + result.message);
      }
    } catch (error) {
      console.error('Error en load:', error);
      alert('Error de conexión');
    }
  }
});
</script>