<!DOCTYPE html>
<html lang="es" data-current-user="<%= JSON.stringify(currentUser || null) %>">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agregar Persona - OVD</title>

    <!-- Bootstrap y estilos -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
          <i class="bi bi-shield-check"></i> OVD - Exaltación de la Cruz
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/dashboard"
                ><i class="bi bi-house-door"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/agregar-persona"
                ><i class="bi bi-person-plus"></i> Agregar Persona</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/agregar-caso"
                ><i class="bi bi-file-earmark-plus"></i> Agregar Caso</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/lista-casos"
                ><i class="bi bi-list-ul"></i> Lista de Casos</a
              >
            </li>
          </ul>

          <div class="dropdown me-3">
            <button
              class="btn btn-outline-light dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="bi bi-person-circle"></i>
                            <span id="currentUser">
  <% if (currentUser) { %>
    <%= currentUser.nombre %>
    <small class="text-light-50">
      (<%= currentUser.rol === 1 ? 'Admin' : 'Operador' %>)
    </small>
  <% } else { %>
    Usuario
  <% } %>
</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/register"
                  ><i class="bi bi-gear"></i> Configuración</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button class="dropdown-item text-danger" onclick="logout()">
                  <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENIDO -->
    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h4 class="mb-0">
                <i class="bi bi-person-plus"></i> Agregar Nueva Persona
              </h4>
              <button
                class="btn btn-outline-primary"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#modalListaPersonas"
              >
                <i class="bi bi-list-ul"></i> Ver/Gestionar Personas
              </button>
            </div>
            <div class="card-body">
              <form id="formPersona" action="/agregar-persona" method="POST">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="nombre" class="form-label"
                      >Nombre <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      name="nombre"
                      class="form-control"
                      id="nombre"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="apellido" class="form-label"
                      >Apellido <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      name="apellido"
                      class="form-control"
                      id="apellido"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="dni" class="form-label"
                      >DNI <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      name="dni"
                      class="form-control"
                      placeholder="8 digitos"
                      required
                      minlength="8"
                      maxlength="8"
                      pattern="[0-9]{8}"
                      title="Solo números, de 8 digitos"
                      id="dni"
                    />
                    <small class="text-muted">Ej: 44888777</small>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="telefono" class="form-label"
                      >Teléfono <span class="text-danger">*</span></label
                    >
                    <input
                      type="tel"
                      name="telefono"
                      class="form-control"
                      placeholder="8 a 15 dígitos"
                      required
                      minlength="8"
                      maxlength="15"
                      pattern="\d{8,15}"
                      title="Solo números, de 8 a 15 dígitos"
                      id="telefono"
                    />
                    <small class="text-muted">Ej: 1132323232 ,sin 0 y 15</small>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="direccion" class="form-label"
                      >Dirección <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      name="direccion"
                      class="form-control"
                      id="direccion"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="genero" class="form-label"
                      >Género <span class="text-danger">*</span></label
                    >
                    <select
                      class="form-select"
                      id="genero"
                      name="genero"
                      required
                    >
                      <option value="">Seleccione un género</option>
                      <option value="Masculino">Masculino</option>
                      <option value="Femenino">Femenino</option>
                      <option value="Otro">Otro</option>
                    </select>
                  </div>
                </div>

                <!-- SELECT ZONA -->
                <div class="mb-3">
                  <label for="zona" class="form-label"
                    >Zona <span class="text-danger">*</span></label
                  >
                  <div class="input-group">
                    <select class="form-select" id="zona" name="zona" required>
                      <option value="">Seleccione una zona</option>
                      <% zonas.forEach(z => { %>
                      <option value="<%= z.id_zona %>">
                        <%= z.nombre_zona %>
                      </option>
                      <% }) %>
                    </select>
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#modalAgregarZona"
                    >
                      <i class="bi bi-plus-circle"></i> Agregar Zona
                    </button>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label"
                    >Email <span class="text-muted">(Opcional)</span></label
                  >
                  <input
                    type="email"
                    name="email"
                    class="form-control"
                    id="email"
                    placeholder="ejemplo@gmail.com"
                    title="Debe ser un dominio ejemplo@gmail.com"
                  />
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Guardar Persona
                  </button>
                  <a href="/dashboard" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL AGREGAR ZONA -->
    <div class="modal fade" id="modalAgregarZona" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Nueva Zona</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formZona">
              <div class="mb-3">
                <label for="nombreZona" class="form-label"
                  >Nombre de la Zona</label
                >
                <!-- ← NUEVO: Botón al lado del label para abrir modal de gestión de zonas -->
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary flex-shrink-0 ms-auto"
                  data-bs-toggle="modal"
                  data-bs-target="#modalGestionarZonas"
                >
                  <i class="bi bi-list-ul"></i> Gestionar Zonas
                </button>
                <input
                  type="text"
                  class="form-control"
                  id="nombreZona"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-plus-circle"></i> Agregar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- ← NUEVO: Modal para gestión de zonas (tabla, búsqueda, edición) -->
    <div class="modal fade" id="modalGestionarZonas" tabindex="-1">
      <div class="modal-dialog modal-md">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-geo-alt"></i> Gestionar Zonas
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- ← NUEVO: Barra de búsqueda -->
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                id="searchZonas"
                placeholder="Buscar por nombre de zona..."
              />
            </div>
            <!-- ← NUEVO: Tabla -->
            <div id="listaZonas" class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th style="width: 80%;">Nombre</th>
                    <th style="width: 20%; text-align: right;">Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyZonas">
                  <!-- Dinámico -->
                </tbody>
              </table>
            </div>
            <!-- ← NUEVO: Form edición (oculto) -->
            <div id="formEdicionZona" class="mt-4" style="display: none">
              <h6>Editar Zona</h6>
              <form id="editFormZona">
                <input type="hidden" id="editIdZona" name="id" />
                <div class="mb-3">
                  <label class="form-label">Nombre de la Zona</label>
                  <input
                    type="text"
                    name="nombreZona"
                    class="form-control"
                    required
                  />
                </div>
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary">
                    Actualizar
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="cancelarEdicionZona()"
                  >
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ← NUEVO: Modal para lista de personas con búsqueda, tabla y formulario de edición -->

    <div class="modal fade" id="modalListaPersonas" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-secundary text-white">
            <h5 class="modal-title">
              <i class="bi bi-people"></i> Gestionar Personas
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- BARRA DE BÚSQUEDA -->
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                id="searchPersonas"
                placeholder="Buscar por nombre, apellido, DNI o teléfono..."
              />
            </div>

            <!-- TABLA -->
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>DNI</th>
                    <th>Teléfono</th>
                    <th>Zona</th>
                    <th>Email</th>
                    <th>Género</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyPersonas">
                  <!-- Se llena con JS -->
                </tbody>
              </table>
            </div>

            <!-- PAGINACIÓN -->
            <div class="d-flex justify-content-center mt-4">
              <nav aria-label="Paginación de personas">
                <ul class="pagination" id="paginacionPersonas">
                  <!-- Generado por JS -->
                </ul>
              </nav>
            </div>

            <!-- FORMULARIO DE EDICIÓN (OCULTO) -->
            <div
              id="formEdicionPersona"
              class="mt-5 border-top pt-4"
              style="display: none"
            >
              <h5 class="text-primary mb-4">
                <i class="bi bi-pencil-square"></i> Editar Persona
              </h5>
              <form id="editFormPersona">
                <input type="hidden" id="editIdPersona" name="id" />
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nombre</label>
                    <input
                      type="text"
                      name="nombre"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Apellido</label>
                    <input
                      type="text"
                      name="apellido"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">DNI</label>
                    <input
                      type="text"
                      name="dni"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Teléfono</label>
                    <input
                      type="tel"
                      name="telefono"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Dirección</label>
                    <input
                      type="text"
                      name="direccion"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Género</label>
                    <select class="form-select" name="genero" required>
                      <option value="Masculino">Masculino</option>
                      <option value="Femenino">Femenino</option>
                      <option value="Otro">Otro</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Zona</label>
                    <select class="form-select" name="zona" required>
                      <% zonas.forEach(z => { %>
                      <option value="<%= z.id_zona %>">
                        <%= z.nombre_zona %>
                      </option>
                      <% }) %>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" />
                  </div>
                </div>
                <div class="d-flex gap-2 mt-4">
                  <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-check2"></i> Guardar Cambios
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="cancelarEdicion()"
                  >
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL PARA EDITAR PERSONA (NUEVO Y SEPARADO) -->
    <div class="modal fade" id="modalEditarPersona" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square"></i> Editar Persona
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formEditarPersonaReal">
              <input type="hidden" id="idPersonaEditar" />

              <div class="row g-3">
                <div class="col-md-6">
                  <label>Nombre *</label
                  ><input
                    type="text"
                    name="nombre"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label>Apellido *</label
                  ><input
                    type="text"
                    name="apellido"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label>DNI *</label
                  ><input
                    type="text"
                    name="dni"
                    class="form-control"
                    maxlength="8"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label>Teléfono *</label
                  ><input
                    type="tel"
                    name="telefono"
                    class="form-control"
                    maxlength="10"
                    required
                  />
                </div>
                <div class="col-12">
                  <label>Dirección *</label
                  ><input
                    type="text"
                    name="direccion"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label>Género *</label>
                  <select name="genero" class="form-select" required>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label>Zona *</label>
                  <select name="zona" class="form-select" required>
                    <% zonas.forEach(z => { %>
                    <option value="<%= z.id_zona %>">
                      <%= z.nombre_zona %>
                    </option>
                    <% }) %>
                  </select>
                </div>
                <div class="col-12">
                  <label>Email (opcional)</label
                  ><input type="email" name="email" class="form-control" />
                </div>
              </div>

              <div class="mt-4 d-flex justify-content-end gap-2">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // FORMULARIO DE PERSONA
      const formPersona = document.getElementById("formPersona");

      formPersona.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = Object.fromEntries(new FormData(formPersona).entries());

        const res = await fetch("/agregar-persona", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (result.success) {
          Swal.fire({
            icon: "success",
            title: result.message,
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            window.location.href = "/agregar-caso";
          });
        } else {
          Swal.fire("Error", result.message, "error");
        }
      });

      // FORMULARIO DE ZONA (MODAL)
      const formZona = document.getElementById("formZona");
      formZona.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombreZona = document.getElementById("nombreZona").value.trim();

        const res = await fetch("/zonas/agregar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombreZona }),
        });

        const result = await res.json();

        if (result.success) {
          const select = document.getElementById("zona");
          const option = document.createElement("option");
          option.value = result.id;
          option.textContent = nombreZona;
          select.appendChild(option);
          select.value = result.id;

          document.getElementById("nombreZona").value = "";

          bootstrap.Modal.getInstance(
            document.getElementById("modalAgregarZona")
          ).hide();
          Swal.fire("Zona agregada", "Se agregó correctamente", "success");
        } else {
          Swal.fire("Error", result.message, "error");
        }
      });
      // ← NUEVO: Gestión de zonas (carga, filtro, editar, borrar)
      let todasLasZonas = [];
      let editingIdZona = null;
      document.addEventListener("DOMContentLoaded", () => {
        // ← NUEVO: Event listeners para modal de zonas
        document
          .getElementById("modalGestionarZonas")
          .addEventListener("show.bs.modal", cargarZonas);
        document
          .getElementById("searchZonas")
          .addEventListener("input", filtrarZonas);
        document
          .getElementById("editFormZona")
          .addEventListener("submit", editarZonaSubmit);
      });
      async function cargarZonas() {
        try {
          const res = await fetch("/zonas");
          const { zonas } = await res.json();
          todasLasZonas = zonas;
          renderizarZonas(zonas);
        } catch (err) {
          Swal.fire("Error", "No se pudieron cargar las zonas", "error");
        }
      }
      function renderizarZonas(zonas) {
        const tbody = document.getElementById("tbodyZonas");
        tbody.innerHTML = "";
        zonas.forEach((z) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${z.nombre_zona}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editarZona(${z.id_zona})">
              ✏️
            </button>
            <button class="btn btn-sm btn-danger" onclick="borrarZona(${z.id_zona})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }
      function filtrarZonas() {
        const termino = document
          .getElementById("searchZonas")
          .value.toLowerCase();
        const filtradas = todasLasZonas.filter((z) =>
          z.nombre_zona.toLowerCase().includes(termino)
        );
        renderizarZonas(filtradas);
      }
      async function editarZona(id) {
        const zona = todasLasZonas.find((z) => z.id_zona === id);
        if (!zona) return;
        editingIdZona = id;
        document.getElementById("editIdZona").value = id;
        document.querySelector('#editFormZona input[name="nombreZona"]').value =
          zona.nombre_zona;
        document.getElementById("searchZonas").style.display = "none";
        document.getElementById("listaZonas").style.display = "none";
        document.getElementById("formEdicionZona").style.display = "block";
      }
      function cancelarEdicionZona() {
        document.getElementById("formEdicionZona").style.display = "none";
        document.getElementById("listaZonas").style.display = "block";
        editingIdZona = null;
      }
      async function editarZonaSubmit(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());

        try {
          const res = await fetch(`/zonas/${editingIdZona}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await res.json();

          if (result.success) {
            // CERRAR MODAL DE GESTIÓN
            bootstrap.Modal.getInstance(
              document.getElementById("modalGestionarZonas")
            ).hide();

            // RECARGAR ZONAS EN TODOS LOS SELECTS
            await recargarZonasEnSelects();

            // VOLVER A LISTA
            cancelarEdicionZona();

            // ÉXITO
            await Swal.fire({
              title: "¡Actualizado!",
              text: result.message,
              icon: "success",
              timer: 1500,
              showConfirmButton: false,
            });
          } else {
            Swal.fire("Error", result.message, "error");
          }
        } catch (err) {
          console.error("Error:", err);
          Swal.fire("Error", "No se pudo actualizar la zona", "error");
        }
      }
      async function borrarZona(id) {
        const zona = todasLasZonas.find((z) => z.id_zona === id);
        Swal.fire({
          title: `¿Borrar "${zona.nombre_zona}"?`,
          text: "Esta acción no se puede deshacer.",
          icon: "warning",
          showCancelButton: true,
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/zonas/${id}`, { method: "DELETE" });
              const data = await res.json();

              if (data.success) {
                // RECARGAR ZONAS EN TODOS LOS SELECTS
                await recargarZonasEnSelects();

                // RECARGAR TABLA DE ZONAS
                renderizarZonas(todasLasZonas);

                // MENSAJE
                await Swal.fire({
                  title: "¡Eliminado!",
                  text: data.message || "Zona borrada correctamente",
                  icon: "success",
                  timer: 1500,
                  showConfirmButton: false,
                });
              } else {
                Swal.fire("Error", data.message, "error");
              }
            } catch (err) {
              Swal.fire("Error", "No se pudo borrar", "error");
            }
          }
        });
      }

      // NUEVO: Gestión de personas
      const ITEMS_POR_PAGINA = 10;
      let todasLasPersonas = [];
      let paginaActualPersonas = 1;

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("modalListaPersonas")
          .addEventListener("show.bs.modal", cargarPersonas);
        document
          .getElementById("searchPersonas")
          .addEventListener("input", aplicarFiltrosYPaginaPersonas);
        document
          .getElementById("editFormPersona")
          .addEventListener("submit", editarPersonaSubmit);
      });

      async function cargarPersonas() {
        try {
          const res = await fetch("/personas");
          const { personas } = await res.json();
          todasLasPersonas = personas;
          aplicarFiltrosYPaginaPersonas();
        } catch (err) {
          Swal.fire("Error", "No se pudieron cargar las personas", "error");
        }
      }

      function aplicarFiltrosYPaginaPersonas() {
        const search = document
          .getElementById("searchPersonas")
          .value.toLowerCase()
          .trim();
        let filasVisibles = todasLasPersonas.filter((p) => {
          return (
            p.nombre.toLowerCase().includes(search) ||
            p.apellido.toLowerCase().includes(search) ||
            p.dni.includes(search) ||
            (p.telefono && p.telefono.includes(search))
          );
        });

        const totalPaginas = Math.ceil(filasVisibles.length / ITEMS_POR_PAGINA);
        paginaActualPersonas = 1;

        renderizarPersonas(filasVisibles.slice(0, ITEMS_POR_PAGINA));
        generarPaginacionPersonas(totalPaginas, filasVisibles);
      }

      function renderizarPersonas(personas) {
        const tbody = document.getElementById("tbodyPersonas");
        tbody.innerHTML = "";

        if (personas.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No se encontraron personas</td></tr>`;
          return;
        }

        personas.forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td><strong>${p.nombre}</strong></td>
      <td>${p.apellido}</td>
      <td>${p.dni}</td>
      <td>${p.telefono || "-"}</td>
      <td>${p.zona || "Sin zona"}</td>
      <td>${p.email || ""}</td>
      <td>${p.genero}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="abrirModalEditar(${
          p.id
        })">
           ✏️
         </button>
        ${
          window.currentUser && window.currentUser.rol === 1
            ? `
        <button class="btn btn-danger btn-sm" onclick="borrarPersona(${p.id})">
          <i class="bi bi-trash"></i>
        </button>`
            : ""
        }
      </td>
    `;
          tbody.appendChild(tr);
        });
      }

      function generarPaginacionPersonas(totalPaginas, filasVisibles) {
        const paginacion = document.getElementById("paginacionPersonas");
        paginacion.innerHTML = "";

        if (totalPaginas <= 1) return;

        // Anterior
        paginacion.innerHTML += `
    <li class="page-item ${paginaActualPersonas === 1 ? "disabled" : ""}">
      <a class="page-link" href="#" onclick="cambiarPaginaPersonas(${
        paginaActualPersonas - 1
      }, event)">Anterior</a>
    </li>`;

        // Números
        for (let i = 1; i <= totalPaginas; i++) {
          paginacion.innerHTML += `
      <li class="page-item ${i === paginaActualPersonas ? "active" : ""}">
        <a class="page-link" href="#" onclick="cambiarPaginaPersonas(${i}, event)">${i}</a>
      </li>`;
        }

        // Siguiente
        paginacion.innerHTML += `
    <li class="page-item ${
      paginaActualPersonas === totalPaginas ? "disabled" : ""
    }">
      <a class="page-link" href="#" onclick="cambiarPaginaPersonas(${
        paginaActualPersonas + 1
      }, event)">Siguiente</a>
    </li>`;
      }

      window.cambiarPaginaPersonas = function (pag, event) {
        event.preventDefault();
        if (
          pag < 1 ||
          pag > Math.ceil(todasLasPersonas.length / ITEMS_POR_PAGINA)
        )
          return;

        paginaActualPersonas = pag;
        const search = document
          .getElementById("searchPersonas")
          .value.toLowerCase()
          .trim();
        let filasVisibles = todasLasPersonas.filter((p) => {
          return (
            p.nombre.toLowerCase().includes(search) ||
            p.apellido.toLowerCase().includes(search) ||
            p.dni.includes(search) ||
            (p.telefono && p.telefono.includes(search))
          );
        });

        const inicio = (pag - 1) * ITEMS_POR_PAGINA;
        const fin = inicio + ITEMS_POR_PAGINA;

        renderizarPersonas(filasVisibles.slice(inicio, fin));
        generarPaginacionPersonas(
          Math.ceil(filasVisibles.length / ITEMS_POR_PAGINA),
          filasVisibles
        );
      };

      // FUNCIÓN CANCELAR EDICIÓN (CORREGIDA)
      function cancelarEdicion() {
        // VOLVER A MOSTRAR todo
        document.getElementById("searchPersonas").style.display = "block";
        document.querySelector(".table-responsive").style.display = "block";
        document
          .querySelector("#paginacionPersonas")
          .closest(".d-flex").style.display = "flex";

        // OCULTAR formulario
        document.getElementById("formEdicionPersona").style.display = "none";

        editingId = null;
      }

      function cancelarEdicion() {
        document.getElementById("formEdicionPersona").style.display = "none";
        document.getElementById("listaPersonas").style.display = "block";
        editingId = null;
      }

      async function editarPersonaSubmit(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        try {
          const res = await fetch(`/personas/${editingId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await res.json();
          if (result.success) {
            Swal.fire("Éxito", result.message, "success").then(() => {
              cancelarEdicion();
              cargarPersonas(); // Recargar lista
            });
          } else {
            Swal.fire("Error", result.message, "error");
          }
        } catch (err) {
          Swal.fire("Error", "No se pudo actualizar", "error");
        }
      }

      async function borrarPersona(id) {
        const persona = todasLasPersonas.find((p) => p.id === id);
        if (!persona) return;

        const result = await Swal.fire({
          title: `¿Eliminar a ${persona.nombre} ${persona.apellido}?`,
          text: "Esta acción no se puede deshacer.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Sí, eliminar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#d33",
        });

        if (result.isConfirmed) {
          try {
            const res = await fetch(`/borrarPersona/${id}`, {
              method: "DELETE",
              credentials: "include", // ← IMPORTANTE: para que envíe la sesión
            });

            if (!res.ok) {
              const error = await res
                .json()
                .catch(() => ({ message: "Error del servidor" }));
              throw new Error(error.message || "No se pudo borrar");
            }

            const data = await res.json();

            if (data.success) {
              await Swal.fire({
                title: "¡Eliminado!",
                text: data.message || "Persona borrada correctamente",
                icon: "success",
                timer: 1800,
                timerProgressBar: true,
                showConfirmButton: false,
              });
              cargarPersonas(); // Recarga la lista
            }
          } catch (err) {
            console.error("Error al borrar:", err);
            Swal.fire("Error", err.message || "No se pudo eliminar", "error");
          }
        }
      }

      // ← NUEVO: RECARGAR ZONAS EN TODOS LOS SELECTS
      async function recargarZonasEnSelects() {
        try {
          const res = await fetch("/zonas");
          if (!res.ok) throw new Error("Error al cargar zonas");
          const { zonas } = await res.json();

          // 1. SELECT PRINCIPAL (formulario agregar persona)
          const selectPrincipal = document.getElementById("zona");
          const valorActual = selectPrincipal.value;
          selectPrincipal.innerHTML =
            '<option value="">Seleccione una zona</option>';
          zonas.forEach((z) => {
            const opt = new Option(z.nombre_zona, z.id_zona);
            if (z.id_zona == valorActual) opt.selected = true;
            selectPrincipal.add(opt);
          });

          // 2. SELECT EN MODAL DE EDICIÓN DE PERSONA
          const selectEdicion = document.querySelector(
            '#editFormPersona select[name="zona"]'
          );
          if (selectEdicion) {
            const valorEdicion = selectEdicion.value;
            selectEdicion.innerHTML = "";
            zonas.forEach((z) => {
              const opt = new Option(z.nombre_zona, z.id_zona);
              if (z.id_zona == valorEdicion) opt.selected = true;
              selectEdicion.add(opt);
            });
          }

          // 3. ACTUALIZAR VARIABLE GLOBAL
          todasLasZonas = zonas;

          console.log("Zonas recargadas en todos los selects");
        } catch (err) {
          console.error("Error recargando zonas:", err);
          Swal.fire("Error", "No se pudieron actualizar las zonas", "error");
        }
      }
    </script>

    <script>
      async function logout() {
        try {
          const response = await fetch("/logout", {
            method: "POST",
            credentials: "include",
          });
          if (response.ok) {
            // Redirige al login si se cerró correctamente
            window.location.href = "/login?alert=logout";
          } else {
            Swal.fire("Error", "No se pudo cerrar la sesión", "error");
          }
        } catch (err) {
          console.error(err);
          Swal.fire("Error", "Hubo un problema al cerrar la sesión", "error");
        }
      }
    </script>
    <!-- DEBUG: VERIFICA SI currentUser LLEGA -->
    <script>
      console.log('DEBUG: currentUser desde EJS:', <%- JSON.stringify(currentUser || null) %>);
    </script>
    <script>
      // Leer el usuario desde el atributo data-current-user (string escapado por EJS)
      const currentUserRaw =
        document.documentElement.getAttribute("data-current-user");
      try {
        window.currentUser = currentUserRaw ? JSON.parse(currentUserRaw) : null;
      } catch (err) {
        console.error("Error parseando currentUser:", err);
        window.currentUser = null;
      }

      if (window.currentUser && document.getElementById("currentUser")) {
        document.getElementById("currentUser").textContent =
          window.currentUser.nombre || window.currentUser.username || "Usuario";
      }
    </script>
    <script>
      // Limpia DNI y TELÉFONO automáticamente (solo números + longitud exacta)
      document
        .querySelectorAll('input[name="dni"], input[name="telefono"]')
        .forEach((input) => {
          input.addEventListener("input", function () {
            // Borra todo lo que no sea número
            this.value = this.value.replace(/\D/g, "");
            // Limita la longitud según el campo
            if (this.name === "dni") this.value = this.value.slice(0, 8); // DNI: máx 8
            if (this.name === "telefono") this.value = this.value.slice(0, 15); // Tel: máx 15
          });
        });

      // ABRIR MODAL DE EDICIÓN CON DATOS
      window.abrirModalEditar = function (id) {
        const persona = todasLasPersonas.find((p) => p.id === id);
        if (!persona) return;

        // ← NUEVA LÍNEA: CERRAR EL MODAL DE LISTA DE PERSONAS
        bootstrap.Modal.getInstance(
          document.getElementById("modalListaPersonas")
        )?.hide();

        // Rellenar los campos
        document.getElementById("idPersonaEditar").value = persona.id;
        document.querySelector(
          '#formEditarPersonaReal input[name="nombre"]'
        ).value = persona.nombre;
        document.querySelector(
          '#formEditarPersonaReal input[name="apellido"]'
        ).value = persona.apellido;
        document.querySelector(
          '#formEditarPersonaReal input[name="dni"]'
        ).value = persona.dni;
        document.querySelector(
          '#formEditarPersonaReal input[name="telefono"]'
        ).value = persona.telefono || "";
        document.querySelector(
          '#formEditarPersonaReal input[name="direccion"]'
        ).value = persona.direccion || "";
        document.querySelector(
          '#formEditarPersonaReal input[name="email"]'
        ).value = persona.email || "";
        document.querySelector(
          '#formEditarPersonaReal select[name="genero"]'
        ).value = persona.genero;
        document.querySelector(
          '#formEditarPersonaReal select[name="zona"]'
        ).value = persona.zona_id || persona.zona || "";

        // Abrir el modal de edición
        new bootstrap.Modal(
          document.getElementById("modalEditarPersona")
        ).show();
      };

      // GUARDAR EDICIÓN
      document
        .getElementById("formEditarPersonaReal")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const id = document.getElementById("idPersonaEditar").value;
          const data = Object.fromEntries(new FormData(this));

          try {
            const res = await fetch(`/personas/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();

            if (result.success) {
              Swal.fire("¡Listo!", "Persona actualizada", "success");
              bootstrap.Modal.getInstance(
                document.getElementById("modalEditarPersona")
              ).hide();
              cargarPersonas(); // recarga la tabla
            } else {
              Swal.fire(
                "Error",
                result.message || "No se pudo guardar",
                "error"
              );
            }
          } catch (err) {
            console.error(err);
            Swal.fire("Error", "No se pudo conectar", "error");
          }
        });
    </script>
  </body>
</html>
